<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
		<title>MarqetPlace Visualizer</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
	
	</head>
	<style>
		 body { 			font-family:SegoeUI,Verdana,Geneva,sans-serif; font-size:14px; box-sizing:border-box; 
							padding:0; margin:0; position:fixed; width:100%; 
							}
		.mq-splash { 		color:#999; text-align:center; margin-top:10%;
							}
		.mq-main { 			width:100%; height:var(--maxvh);  user-select: none; display:none;
							}
		.mq-confirm {		position:absolute;  width:300px; padding: 16px; left:calc(50% - 150px); top:calc(50vh - 50px); user-select: none;	
							border-radius: 8px; background-color: #fff; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							}
		.mq-popup {			position:absolute;  width: auto; max-width:200px; padding: 12px; left: calc(50% - 100px); top: calc(66% - 50px);
							border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							font-size: 14px; text-align:center; display: none;
							}
		.mq-is {			border-radius:16px; padding:0 8px;border:1px solid #999; font-size: 12px;
							}
		.mq-bs {			cursor: pointer; color:#fff; text-align: center; border-radius: 16px; display: inline-block;
							font-size: 10px; background-color: #27ae60; padding: 0 12px; vertical-align:1px;user-select: none;
							} 
							
		.ui-menu { width:100px; margin:4px 0 0 20px; font-size:13px; display:none}
		:root  {			--maxvh: 100vh  }
		table  {			border-spacing: 0px;  }
		@font-face {  		font-family: SegoeUI; src: url(img/segoeui.ttf);   }

		body ::-webkit-scrollbar { width: 9px; height:8px } 
		body ::-webkit-scrollbar-track { background: transparent; }
		body ::-webkit-scrollbar-thumb { border-radius:8px ;background:#a4baec }
		body ::-webkit-scrollbar-thumb:hover { background: #a4baec }

</style>
<body>

	<div id="menuBar" style="width:100%;height:20px;background-color:#ddd;user-select:none;">
		<span id="fileMenu" style="margin-left:26px;cursor:pointer">File</span>
		<select id="grain" class="mq-is" style="margin-left:50px;cursor:pointer">
			<option value=".4">Normal grain</option>
			<option value=".1">Very fine grain</option>
			<option value=".2">Fine grain</option>
			<option value=".6">Coarse grain</option>
			<option value="1.0">Very coarse grain</option>
		</select>
		<select id="rotation" class="mq-is" style="margin-left:8px;cursor:pointer">
			<option value="0">No rotation</option>
			<option value="1">22 degrees</option>
			<option value="2">45 degrees</option>
			<option value="3">68 degrees</option>
			<option value="4">90 degrees</option>
			<option value="5">112 degrees</option>
			<option value="6">135 degrees</option>
			<option value="7">160 degrees</option>
		</select>
		<select id="veneer" class="mq-is" style="margin-left:8px;cursor:pointer">
			<option>No veneer</option>
		</select>
		<div class="mq-bs" style="margin-left:8px" onclick="app.ApplyVeneer()">SET</div>
		<div style="margin-right:12px;cursor:pointer;float:right">
			<img id="scaleDown" src="img/downdot.gif" style="margin-right:12px" title="Make SVG smaller">
			<img id="scaleUp" src="img/updot.gif" title="Make SVG bigger">
		</div>
		<ul id="fmenu">
			<div style="margin-right:12px;cursor:pointer;width:150px">
			<li><div id="loadSVG">Load SVG</div></li>
			<li><div id="loadSample">Load sample SVG</div></li>
			<li><div id="addVeneer">Add veneer</div>
		</ul>		
	</div>
	<div id="imageDiv" >
		<object id="svgFile"></object>
	</div>
	<input type="file" id="mq-svgFilePick" style="display:none">
	
<script>

/////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

	var app=null;

	$(document).ready(function() {								           						// ON PAGE LOADED
		$("#fmenu" ).menu();																		// Alloc file menu
		$("#splashDiv").fadeIn(2000);																// Fade in splash page
		app=new App();																				// Alloc app

		$("body").on("click", (e)=>{																// ON BODY CLICK
			if (e.target.id != "fileMenu")	$("#fmenu").hide(); 									// If not menu button, close menu									 
			if (e.target.id == "saveSVG")	app.SaveSVG(); 											// Save SVG								 
			if (e.target.id == "loadSVG")	$("#mq-svgFilePick").trigger("click");	 				// Load SVG								 
			if (e.target.id == "loadSample")$("#svgFile").prop("data", "steamboat.svg"),$("#svgFile").on("load", ()=>{ app.ProcessSVG(); }); // Load sampleSVG								 
			if (e.target.id == "addVeneer")	$("#mq-veneerFilePick").trigger("click");				// Load veneer						 
			});											
		$("#scaleUp").on("click",  	()=>{app.scale*=2; app.Scale(); });								// SCALE UP
		$("#scaleDown").on("click",	()=>{app.scale/=2; app.Scale() });								// SCALE DOWN
		$("#fileMenu").on("click", 	()=>{ $("#fmenu").show(); });									// OPEN FILE MENU
		$("#grain").on("change",   	()=>{ app.ScaleVeneers($("#grain").val()); });					// SET VENEER GRAIN LEVEL
		$("#veneer").on("change",  	()=>{ app.ApplyVeneer(); });									// SET SELECTED PANES WITH VENEER
		$("#rotation").on("change", ()=>{ app.ApplyVeneer(); });									// SET SELECTED PANES WITH VENEER
		$("#mq-svgFilePick").on("change",(e)=>{	app.ReadSVGFile(e);	});								// SVG FILE PICK
	});

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor()   																			// CONSTRUCTOR
	{
		app=this;																					// App global pointer
		this.svg={};																				// Hold SVG file
		this.paths=[];																				// Hold SVG paths
		this.selects=[];																			// Hold selects
		this.scale=1;																				// SVG scale factor
		this.vScale=.4;																				// Veneer scaling
		this.bBox={}																				// Original SVG bounding box
		this.lineWid=1;																				// Line width
		this.veneers=["Anigre","Birch","Bubinga","Cherry","Eucalyptus","Lacewood",					// Veneer list
			"Lark","Mahogany","Makope","Maple","Padauk","Poplar","RedBurl","RedOak",
			"Saple","SmokedOak","Walnut","Wenge","Zebrawood" ];
		$("#svgFile").prop("data", "logo2.svg");													// Load file
		$("#svgFile").on("load", ()=>{ this.ProcessSVG(); });										// When loaded
	}

	Scale()																						// SCALE SVG
	{
		let x=this.bBox.width/this.scale/.8;			
		let y=this.bBox.height/this.scale/.8;														
		$(this.svg.querySelectorAll("svg"))[0].setAttribute("viewBox",`${-x/10+this.bBox.x} ${this.bBox.y} ${x} ${y}`);	
	}

	ProcessSVG(callback)																		// PROCES SVG AFTER LOADING
	{
		let i,o;
		let w=window.innerWidth;																	// Desired width
		this.svg=document.getElementById("svgFile").contentDocument;								// Point at SVG object
		this.paths=Array.from(this.svg.querySelectorAll("path"));									// Get all paths
		this.bBox=$(this.svg.querySelectorAll("svg"))[0].getBBox();									// Get bounding boxs
		this.lineWid=this.bBox.width/w;																// Line width based on frame
		this.AddVeneers(this.veneers);																// Add default veneers											
		
		$(this.svg.querySelectorAll("svg"))[0].removeAttribute("height")							// Disable height
		$(this.svg.querySelectorAll("svg"))[0].setAttribute("width",window.innerWidth)				// Set width
		$(this.svg.querySelectorAll("svg"))[0].setAttribute("height",window.innerHeight-30)			// Set width
		this.Scale();																				// Scale SVG

		for (i=0;i<this.paths.length;++i) {															// For each path
			o=this.paths[i];																		// Point at it
			o.id="ptx-"+i;																			// Set id																						
			o.isSelected=0;																			// Not selected
			$(o).css({"stroke":"#000", "stroke-width":this.lineWid, "fill":"#fff"});				// Black edge and filled
			
			$(this.svg).on("click",(e)=>{ 															// ON SVG CLICK
				if (e.target.id.substring(0,4) != "ptx-") {
					for (i=0;i<this.paths.length;++i) this.paths[i].isSelected=0;					// Deselect all
					showSelects();																	// Show what's selected
					e.stopImmediatePropagation();													// Stop propagation
					}
				});
			$(o).on("dblclick",(e)=>{ 																// ON DOUBLE CLICK PATH
				let id=e.target.id.substring(4)-0;													// Get id
				this.paths[id].isSelected=1;														// Select this one
				this.ApplyVeneer();																	// Apply veneer to path													
				});
			
			$(o).on("click",(e)=>{ 																	// ON PATH CLICK
				let id=e.target.id.substring(4)-0;													// Get id
				if (e.ctrlKey || e.shiftKey) 														// Control or shift key
					this.paths[id].isSelected=1-this.paths[id].isSelected;							// Toggle selection status									
				else{																				// Select just one
					for (i=0;i<this.paths.length;++i) this.paths[i].isSelected=0;					// Deselect all
					this.paths[id].isSelected=1;													// Select this one
					}
				showSelects();																		// Show what's selected
				});
			}
	
	if (callback)	callback();																		// Run callback if set

	function showSelects() {																		// SHOW WHAT'S SELECTED
		let i;
		for (i=0;i<app.paths.length;++i) {															// For each path
			if (app.paths[i].isSelected)	$(app.paths[i]).css({"stroke":"red",  "stroke-width":app.lineWid*2 });	// Select
			else					  		$(app.paths[i]).css({"stroke":"#000", "stroke-width":app.lineWid   });	// Deselect
			}
		}
	}

	AddVeneers()																				// ADD VENEER AS SVG PATTERN
	{
		let i,j,pat;
		let svg=this.svg.querySelectorAll("svg")
		let vs=this.bBox.width/window.innerWidth*this.vScale;										// Veneer scale based on frame
		for (i=0;i<this.veneers.length;++i)	{														// For each veneer
			$("#veneer").append("<option>"+this.veneers[i]+"</option>");							// Add to select
			for (j=0;j<8;++j) {																		// For each angle
				pat=document.createElementNS("http://www.w3.org/2000/svg", 'pattern'); 				// Create a pattern in SVG's namespace
				pat.setAttribute("patternUnits","userSpaceOnUse");									// Pattern unit
				pat.setAttribute("width","1024"); 	pat.setAttribute("height","1024"); 				// Pattern size
				pat.setAttribute("id","pat-"+app.veneers[i]+j); 									// Id
				pat.setAttribute("patternTransform",`rotate(${j*22.5}) scale(${vs} ${vs})`); 		// Transform
				$(pat).html(`<image href="veneers/${app.veneers[i]}.jpg"/>`);						// Image
				$(this.svg.querySelectorAll("svg")).prepend(pat);									// Append to SVG
				}			
			}
		}

	ScaleVeneers(scale)																			// SCALE VENEERS
	{
		let i,r;
		let vs=this.bBox.width/window.innerWidth*scale;												// Veneer scale based on frame
		let v=Array.from(this.svg.querySelectorAll("pattern"));										// Get all patterns
		for (i=0;i<v.length;++i) {																	// For each one
			r=v[i].id.match(/.*(\d.*)/)[1];															// Get rotation
			v[i].setAttribute("patternTransform",`rotate(${r*22.5}) scale(${vs} ${vs})`); 			// Set transform	
			}
		}

	ApplyVeneer()																				// SET PATH'S VENEER
	{
		let i;
		let v=$("#veneer").val();																	// Get veneer
		let a=$("#rotation").val();																	// Get rotatiomn
		for (i=0;i<this.paths.length;++i) {															// For each path
			if (this.paths[i].isSelected)	$(this.paths[i]).css({"fill":"url(#pat-"+v+a+")"});		// Set fill					
			}
	}

	SaveSVG()																					// SAVE SVG TO DISK 
	{
		GetTextBox("Save SVG", "Type name to save SGV as","", (s)=>{				
			let str=$(this.svg.querySelectorAll("svg"))[0].outerHTML;
			str=str.replace(/&quot;/g,'"');
			SaveTextAsFile(s+".svg",str);
			});	
	}

	ReadSVGFile(e) 																				// READ FILE FROM LOCAL COMPUTER
	{
		let o=[],i;
		let file=e.target.files[0];																	// Get file
		if (!file) 	return;																			// Quit if bad
		let reader=new FileReader();																// Open reader
		reader.readAsText(file);																	// Convert to text
		reader.onload=(e)=>{  																		// WHEN LOADED
			let root=$(this.svg.querySelectorAll("svg"));											// Point at root
			root.empty();																			// Erase current SVG
			let s=new DOMParser().parseFromString(e.target.result,"image/svg+xml").children[0];		// Parse to SVG's children
			for (i=0;i<s.children.length;++i) 	o.push(s.children[i]);								// Add to array
			for (i=0;i<o.length;++i) root.append(o[i]);												// Add to SVG
			this.ProcessSVG();																		// Scale
			};
	}

}	// App class closure



/////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS 
/////////////////////////////////////////////////////////////////////////////////////////////////

function trace(msg, p1, p2, p3, p4)																// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		var snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
		}

	function PopUp(msg, time, div)																	// TIMED POPUP
	{
		var str="";
		$("#popupDiv").remove();																		// Kill old one, if any
		str+="<div id='popupDiv' class='mq-popup'>"; 													// Add div
		if (time == -1) {																				// If has close but
			time=100000;																				// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";		// Add close button
			}
		str+=msg+"</div>"; 																				// Add div
		$(div ? "#"+div : "body").append(str);															// Add popup to div or body
		$("#pu-close").click(function() { $("#popupDiv").remove(); });									// Remove on click of close but
		$("#popupDiv").fadeIn(500).delay(time ? time*1000 : 3000).fadeOut(500);							// Animate in and out		
	}

	function GetTextBox(title, content, def, callback)												// GET TEXT LINE BOX
	{
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='mq-confirm' id='confirmBoxDiv'></div>");							// Add box								
		var str="<img src='img/logo.png' width='64' style='vertical-align:-8px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:14px; color:#666'><b>"+title+"</b></span><br><br>";
		str+="<p>"+content+"<p>";
		str+="<p><input class='mq-is' style='width:75%;height:20px' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='mq-bs'>OK</div>";
		str+="<div id='dialogCancel' class='mq-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);																	// Add to div
		$("#gtBoxTt").focus();																			// Focus on button
		$("#gtBoxTt").on("change", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ONE ENTER
		$("#dialogOK").on("click", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ON OK 
		$("#dialogCancel").on("click", function() {	$("#confirmBoxDiv").remove(); });								// ON CANCEL
		}

	function SaveTextAsFile(file, contents)															// SAVE TEXT TO LOCAL FILE
	{
		if (file.charAt(0) == "*") {																	// If asking
				GetTextBox("Type file name","", "", (s)=>{ SaveTextAsFile(s+file.substr(1), contents); });		// Ask for name
			return;																						// Quit
			}
		var textFileAsBlob=new Blob([contents], {type:'text/plain'});
		var downloadLink=document.createElement("a");
		downloadLink.download=file;
		downloadLink.innerHTML="Download File";
		downloadLink.href=window.URL.createObjectURL(textFileAsBlob);
	    downloadLink.onclick=()=>{ downloadLink.remove(); };
		downloadLink.style.display="none";
		downloadLink.id="tdll";
		document.body.appendChild(downloadLink);
		downloadLink.click();
	}



</script>
</body>
</html>
